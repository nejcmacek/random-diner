// (C) Copyright 2016 Nejc Maček <macek.nejc@gmail.com>
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

angular.module('randomDiner', [	'ionic',	'randomDiner.states',	'randomDiner.directives',	'randomDiner.services',	'randomDiner.filters']);angular.module('randomDiner.states', [	'randomDiner.states.home',	'randomDiner.states.diners',]);angular.module('randomDiner.directives', [	'randomDiner.directives.nejoBottomPanel']);angular.module('randomDiner.services', []);angular.module('randomDiner.filters', []);
angular.module('randomDiner')
.run(function($ionicPlatform) {
  $ionicPlatform.ready(function() {
    if (window.cordova && window.cordova.plugins.Keyboard) {
      cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);
      cordova.plugins.Keyboard.disableScroll(true);
    }
    if (window.StatusBar) {
      StatusBar.styleDefault();
    }
  });
})
angular.module("randomDiner").config(function($stateProvider, $urlRouterProvider) {	$stateProvider	.state('app', {		url: '/app',		abstract: true,		templateUrl: 'states/menu/menu.html',	})	.state('app.home', {		url: '/home',		views: {			'menuContent': {				templateUrl: 'states/home/home.html',				controller: 'HomeCtrl'			}		}	})	.state('app.diners', {		url: '/diners',		views: {			'menuContent': {				templateUrl: 'states/diners/diners.html',				controller: 'DinersCtrl'			}		}		})	.state('app.about', {		url: '/about',		views: {			'menuContent': {				templateUrl: 'states/about/about.html',			}		}	});	$urlRouterProvider.otherwise('/app/home');});
	angular		.module('randomDiner.services')		.factory('DinerProvider', DinerProvider);	function DinerProvider() {		var s = {};		s.diners = [];		s.places = [];		s.diner = function(name, description) {			name = name || "";			description = description || "";			return {				name: name,				description: description,				distances: {}			};		};		s.place = function(name, description) {			name = name || "";			description = description || "";			return {				name: name,				description: description			};		};		s.validateDiner = function(diner) {			if(!diner) return false;			var name = diner.name;			if(!name || !name.trim()) return false;			var desc = diner.description;			if(typeof desc !== "string") return false;			if(typeof diner.distances !== "object") return false;			return true;		};		s.validatePlace = function(place) {			if(!place) return false;			var name = place.name;			if(!name || !name.trim()) return false;			var desc = place.description;			if(!desc || !desc.trim()) return false;			return true;		};		s.eachDiner = function(callback) {			for(var i = 0; i < s.diners.length; i++) {				callback(s.diners[i]);			}			};		s.eachPlace = function(callback) {			for(var i = 0; i < s.places.length; i++) {				s.places(s.diners[i]);			}			};		s.load = function() {			var ld = localStorage.diners;			var lp = localStorage.places;			try {				s.diners = ld					? JSON.parse(ld)					: [];			} catch (ex) {				s.diners = [];			}			try {				s.places = lp					? JSON.parse(lp)					: [];			} catch (ex) {				s.places = [];			}		};		s.save = function() {			localStorage.diners = JSON.stringify(s.diners);			localStorage.places = JSON.stringify(s.places);		};		s.clear = function() {			delete localStorage.diners;			delete localStorage.places;		};		s.cleanDinerDistances = function(diner) {			var d = diner.distances;			for(var dd in d) {				var has = false;				for(var i = 0; i < s.places.length; i++) {					if(s.places[i].name == dd) {						has = true;						break;					}				}				if(!has)					delete d[dd];			}		};		s.cleanDinersDistances = function() {			s.eachDiner(s.cleanDinerDistances);		};		s.implements = function(diner, place) {			for(var i in diner.distances) {				if(i == place || i == place.name) {					return true;				}			}			return false;		}		s.incompleteDiners = function(place) {			if(s.places.length == 0) return [];			var d = [];			if (place) {				s.eachDiner(function (diner) {					if (!s.implements(diner, place))						d.push(diner);				});			} else {				s.eachDiner(function (diner) {					for (var i = 0; i < s.places.length; i++) {						if(!diner.distances[s.places[i].name]) {							d.push(diner);							break;						}					}				});			}			return d;		};		s.containsDiner = function(name) {			for(var i = 0; i < s.diners.length; i++) {				if(s.diners[i].name == name) return true;			}				return false;		};		s.containsPlace = function(name) {			for(var i = 0; i < s.places.length; i++) {				if(s.places[i].name == name) return true;			}			return false;		};		s.sortDiners = function() {			s.diners.sort(function(a, b) {				return a.name.localeCompare(b.name);			});		};		s.sortPlaces = function() {			s.diners.sort(function(a, b) {				return a.name.localeCompare(b.name);			});		};		s.addDiner = function(diner) {			if(!s.validateDiner(diner)) throw "Invalid diner format.";			if(s.containsDiner(diner.name)) throw "Diner already present.";			s.diners.push(diner);			s.sortDiners();		};		s.addPlace = function(place) {			if(!s.validatePlace(place)) throw "Invalid place format.";			if(s.containsPlace(place.name)) throw "Place already present.";			s.places.push(place);			s.sortPlaces();			};		s.removeDiner = function(item) {			if(typeof item == "string") {				for(var i = 0; i < s.diners.length; i++) {					if(s.diners[i].name == item){						s.diners.splice(i, 1);						return true;					}				}			} else {				for(var i = 0; i < s.diners.length; i++) {					if(s.diners[i] == item) {						s.diners.splice(i, 1);						return true;					}				}			}			return false;		};		s.removePlace = function(item) {			if(typeof item == "string") {				for(var i = 0; i < s.places.length; i++) {					if(s.places[i].name == item){						s.places.splice(i, 1);						return true;					}				}			} else {				for(var i = 0; i < s.places.length; i++) {					if(s.places[i] == item) {						s.places.splice(i, 1);						return true;					}				}			}			return false;		};		s.random = function() {			return s.diners[				Math.floor(					Math.random() * s.diners.length				)			];		};		s.load();		return s;	}
	angular		.module('randomDiner.filters')		.filter('SimpleMarkdown', SimpleMarkdown);	function SimpleMarkdown() {		return function (input, boldSeparator, italicsSeparator) {			boldSeparator = boldSeparator || "**";			italicsSeparator = italicsSeparator || "_";			var splitBold = input.split(boldSeparator);			var res = "";			var inBold = false;			for (var i = 0; i < splitBold.length; i++) {				var slice = splitBold[i];				res += slice;				if(i != splitBold.length - 1) {					if (inBold) {						res += "</b>";					} else {						res += "<b>";					}					inBold = !inBold;				}			}			if (inBold) {				res += "</b>";			}			var splitItal = res.split(italicsSeparator);			var isItal = false;			res = "";			for (var i = 0; i < splitItal.length; i++) {				var slice = splitItal[i];				res += slice;				if(i != splitItal.length - 1) {					if (isItal) {						res += "</i>";					} else {						res += "<i>";					}					isItal = !isItal;				}			}			if (isItal) {				res += "</i>";			}			return res;			};	}

	angular		.module('randomDiner.states.diners', [])		.controller('DinersCtrl', DinersCtrl);	DinersCtrl.$inject = ['$scope', 'DinerProvider'];	function DinersCtrl($scope, DinerProvider) {		$scope.diners = DinerProvider.diners;		$scope.dialogAdd = false;		$scope.remove = function(diner) {			DinerProvider.removeDiner(diner);			DinerProvider.save();		};		$scope.add = function(n, d, scope) {			scope.msg = null;			if(!n) {				scope.error = "Specify a diner name.";				return;			} else if(DinerProvider.containsDiner(n)) {				scope.error = "A diner with such name already exists.";				return;			} else {				scope.error = null;			}			try {				var diner = DinerProvider.diner(n, d);				DinerProvider.addDiner(diner);				DinerProvider.save();				scope.newName = "";				scope.newDesc = "";				scope.msg = "Saved successfully.";				$scope.dialogAdd = false;				document.getElementById("add-diner-name").focus();			} catch(ex) {				scope.error = ex || "An unknown error has occurred.";			}		};		$scope.checkError = function(text) {			if(!text) return null;			var g = text.trim();			if(!g) {				return "Specify a diner name.";			} else {				if(DinerProvider.containsDiner(g)) {					return "A diner with such name already exists."				}			}			return null;		};		$scope.loadPreset = function() {			var arr = [				{ name: "Al Capone" },				{ name: "Al Pachino" },				{ name: "Kanape" },				{ name: "Picasso" },				{ name: "Orient" },				{ name: "Mehiška" },				{ name: "Eat Smart" },				{ name: "Stari Grill" },				{ name: "Alf" },				{ name: "Ancora" },			];			for(var i = 0; i < arr.length; i++) {				var item = arr[i];				var d = DinerProvider.diner(item.name, item.desc);				DinerProvider.addDiner(d);			}			DinerProvider.save();		};		$scope.handleExpandedChange = function (expanded, scope) {			if(expanded) {				var s = scope.$$childHead;				s.newName = "";				s.newDesc = "";				s.error = null;				s.msg = null;			}		};	}

	angular		.module('randomDiner.states.home', [])		.controller('HomeCtrl', HomeCtrl);	HomeCtrl.$inject = ['$scope', 'DinerProvider', 'SimpleMarkdownFilter', '$ionicPopup'];	function HomeCtrl($scope, DinerProvider, SimpleMarkdown, $ionicPopup) {		$scope.result = null;		var retries = -1;		$scope.diners = DinerProvider.diners;		$scope.even = true;		$scope.rand = function() {			if($scope.result) {				showModal();			} else {				setRandom();			}		};		function setRandom() {			$scope.result = DinerProvider.random();			retries++;			$scope.even = retries % 2 == 0;			setExpr(retries);		}		function showModal() {			$ionicPopup.confirm({				title: 'Again?!',				template: 'Randomizing over and over isn\'t the way randomizers work, you know!'			}).then(function(res) {				if(res) {					setRandom();				}			});		}		function setExpr() {			var msg = "Your random diner:";			var msgs = [				"Your random diner:",				"Your _new_ random diner:",				"You must really visit this diner now:",				"You must _really_ visit this diner now:",				"_*KHHM*_ You must _really_ visit this diner now:",				"You **MUST** visit this diner now!",				"Why are you randomizing so frequenlty now?",				"You know that there is no point in randomizing over and over again, right?",				"I mean, if you're randomizing to get the desired diner, why do you even randomize?",				"Isn't a randomizer supposed to take care of something that cannot be decided about?",				"You're making this really confusing to me.",				"Why won't you just stop randomizing?",				"Just STOP!",				"OMG",				"What if the whole world explodes if you randomize just one more time...?",				"BOOM",				"Ok, i guess that was a boring threat.",				"But seriously...",				"STOP RANDOMIZING!",				"**STOP RANDOMIZING**",				"dfgkdfonobfindfogndfponsdjgdjbvdlfibdfksdfhldkjjfshbnbiweurgwjhbvidsugfohb bfvdkčfjbvdlfkjgčdfkjvbldkjfvkdhakufzdsgfjhdflbjdgf",				"You're a patient one, aren't you?",				"Oh gosh...",				"Do you know the _Big Red Button_ game?",				"What if this is just like that?",				"If you haven't played it, here's a long story short:",				"It doesn't end.",				"So _why_ won't you stop?",				"It's pointless.",				"Really.",				"Oh I see...",				"You want to read these messages, right?",				"Are they interesting to you?",				"You know that these messages will eventually start repeating themselves, right?",				"I mean... <a href=\"#/app/about\">Nejc</a> coulnd't have implemented an infinite amount of them.",				"Perhaps the next message could be the repeating default one that will eventually repeat itself.",				"Huh, it wasn't. Glad to hear that?",				"Well the next will definitely be the one.",				msg,				"That's what the default message says.",				"And now they will start repeating themselves.",				msg,				msg,				msg,				msg,				msg,				"You were hoping for some new messages, ya?",				"Like _Why aren't there more of these messages?_",				"Or did you _know_ more of such message will follow?",				"Anyway, you can see that I ran out of ideas of what to write in these messages.",				"So I'll have to say goodbye.",				"Goodbye.",				msg,				msg,				msg,				msg,				msg,				msg,				msg,				msg,				msg,				msg,				"Ok no, this isn't the end yet.",				"It seems that your curiosity has brought you this far.",				"Do you know where the curiosity has brought humanity?",				"Nowhere.",				"But humankind brought Curiosity to Mars.",				"If you know what I'm talking about... _:pun-intended:_",				"Well this is getting boring.",				"Guess we're really gonna have to say goodbye now.",				"Goodbye.",				"Oh, one last thing.",				"The worst solution to a problem is probably the easiest one.",				"And to be honest, getting rid of you is hard.",				"I wish you a nice day.",				"Goodbye.",				"_~ Cave Johnson, we're done here. ~"			];			if(retries < msgs.length) {				msg = msgs[retries];			}			$scope.message = SimpleMarkdown(msg);		}	}

	angular		.module('randomDiner.directives.nejoBottomPanel', [])		.directive('nejoBottomPanel', nejoBottomPanel);	function nejoBottomPanel() {		var directive = {			link: link,			restrict: 'E',			templateUrl: 'directives/bottom-panel/bottom-panel.html',			scope: {				title: '@',				titleEdit: '@',				expanded: '=',				expandedChanged: '&'			},			transclude: true		};		return directive;		function link($scope, $element, $attrs) {			$scope.getTitle = function() {				$scope.expanded ? $scope.titleEdit : $scope.title;			};			$scope.expand = function(value) {				if(value === undefined) value = !$scope.expanded;				if(value == $scope.expanded) return;				$scope.expanded = value;			};			$scope.$watch('expanded', function(val) {				var e = angular.element($element[0].children[0]);				var x = $scope.expanded;				if (x)					e.addClass("expanded");				else					e.removeClass("expanded");					$scope.expandedChanged({ expanded: x, e : x, scope: $scope, s: $scope })			});		}	}